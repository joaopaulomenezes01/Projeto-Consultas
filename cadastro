from struct import pack
import customtkinter as ctk
import tkinter as tk
from tkcalendar import Calendar
from datetime import datetime, date, timedelta
import sqlite3
from PIL import Image, ImageTk

ctk.set_appearance_mode("light")
ctk.set_default_color_theme("blue")
app = ctk.CTk()
app.geometry("900x500")
app.title("Sistema de Login")
frame_esquerda =ctk.CTkFrame(app,fg_color='#F9F9F9',width=400)
frame_esquerda.pack(side='left',fill='both')

imagem = Image.open('images2.jpeg')
imagem = imagem.resize((350,350))
img_tk = ctk.CTkImage(light_image=imagem, size =(350, 350))


imagem_label = ctk.CTkLabel(frame_esquerda, image =img_tk,text='')
imagem_label.image = img_tk
imagem_label.pack(expand=True)


frame_direita = ctk.CTkFrame(app,fg_color='#F9F9F9',width=400)
frame_direita.pack(side='left',fill='both')
titulo = ctk.CTkLabel(frame_direita, text="Sistema de Agendamento de Consultas", font=("Comic Sans MS", 22))
titulo.pack(pady=40)
autores = ctk.CTkLabel(frame_direita, text="Desenvolvido por: JÃºlia Gabrielle e JoÃ£o Paulo", font=("Comic Sans MS", 14))
autores.pack(pady=10)
versÃ£o = ctk.CTkLabel(frame_direita, text="VersÃ£o 1.0", font=("Comic Sans MS", 14))
versÃ£o.pack(pady=5)
direitos = ctk.CTkLabel(frame_direita, text="Â© 2025 Todos os direitos reservados", font=("Comic Sans MS", 14))
direitos.pack(pady=5)


def iniciar_login():
    nova_janela = ctk.CTkToplevel(app)
    nova_janela.geometry('500x400')
    nova_janela.title('Tela de Login')
    ctk.CTkLabel(nova_janela, text="Bem-vindo ao Sistema de Agendamento de Consultas", font=("Arial", 20)).pack(pady=20)
    botÃ£o = ctk.CTkButton(nova_janela, text="Iniciar SessÃ£o", command=login,width=200, height=50)
    botÃ£o.pack(pady=20)

conector = sqlite3.connect('cadastro.db')
conector2 = sqlite3.connect('agendamento.db')
cursor = conector.cursor()
cursor2 = conector2.cursor()


cursor.execute('''
CREATE TABLE IF NOT EXISTS usuarios
(id INTEGER PRIMARY KEY AUTOINCREMENT,
    nome TEXT NOT NULL,
    cpf TEXT NOT NULL,
    data_nascimento TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    senha TEXT NOT NULL) 
''')

cursor2.execute('''
CREATE TABLE IF NOT EXISTS agendamentos
(id integer PRIMARY KEY AUTOINCREMENT, regioes TEXT NOT NULL,
    cidade TEXT NOT NULL,
    especialidade TEXT NOT NULL,
    profissional TEXT NOT NULL,
    horario TEXT NOT NULL,
    data TEXT NOT NULL,
    usuario_id INTEGER NOT NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id))
''') #adc regioes e cidade na tabela de agendamentos

conector.commit()
conector2.commit()

def cadastrar_usuario(nome, cpf, data_nascimento, email, senha):
    try:
        cursor.execute('''
        INSERT INTO usuarios (nome, cpf, data_nascimento, email, senha)
        VALUES (?, ?, ?, ?, ?)
        ''', (nome, cpf, data_nascimento, email, senha))
        conector.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    
def verificar_usuario(email, senha):
    cursor.execute('''
    SELECT id FROM usuarios WHERE email = ? AND senha = ?
    ''', (email, senha))
    usuario = cursor.fetchone()
    return usuario[0] if usuario else None #mudei de select tudo (*) pra sÃ³ o id pra facilitar jÃ¡ que cada um tem id Ãºnico
    
data_nascimento_var = tk.StringVar()

#adc mais profissionais
profissionais = {
    "Cardiologia": ["Dr. VinÃ­cius Gomes","Dr. Gabriel de Souza","DrÂª BÃ¡rbara VitÃ³ria","Dr. Bruno Carvalho","Dr. Manoella Silva","DrÂª Dandara Cruz", "Dr. Celso da Luz"],
    
    "ClÃ­nica Geral": ["Dr. Marcos AndrÃ©","Dr. Wallace Bernardo","DrÂª Beatriz Dias","DrÂª Brenda Maria","Dr. Breno Campos","Dr. Bernardo Maia","DrÂª LuÃ­za Rebecca","DrÂª LaÃ­za Santos" ],

    "Endocrinologia": ["Dr. JosÃ© GonÃ§alves","DrÂª Mirella Alves","Dr. Thiago Ribeiro","Dr. JoÃ£o Victor","Dr. Arthur RebouÃ§as","Dr. Cleiton Pereira","DrÂª Danielle Larissa","DrÂª Diana Cavallazi"],

     "Ginecologia": ["Dr. Pedro Alves","DrÂª Ana Maria","DrÂª Bruna Rodrigues","DrÂª Luana Maria","DrÂª Luna Ribeiro","Dr. Alessandro Victor","Dr. Miguel da Costa"],

     "NutriÃ§Ã£o": ["Dr. JoÃ£o Paulo","DrÂª Maria Alice","DrÂª Kayllane LetÃ­cia","DrÂª VictÃ³ria Almeida","Dr. Alex de Teixeira","Dr. KlÃ©ber Eduardo","Dr. Kleyton Paulo"],

     "Odontologia": ["DrÂª LetÃ­cia Dias","Dr. Matheus Souza","Dr. Rhuan Barros","DrÂª Gleice Batista","DrÂª Jennifer Barbosa","Dr. Pablo Arruda","DrÂª Esther Silva","Dr. Samuel Queiroz"],
    
    "Oftalmologia": ["Dr. Felipe Cunha","Dr. Leandro Moura","DrÂª Laura Campos","DrÂª VictÃ³ria Borges","DrÂª Selma Morais","DrÂª Maura Fontes","Dr. Jonas do Nascimento"],
    
    "Ortopedia": ["DrÂª Marcela Andrade","DrÂª Carolina Oliveira","DrÂª Suellen Ferreira","Dr. Carlos Silva","Dr. Rennan Nunes","Dr. Christiano Fernando","Dr. Luciano Neves","DrÂª Fernanda Ramos"],

     "Pediatria": ["DrÂª Alexandra Barros","DrÂª Camila Ramos","Dr. Diego dos Reis","Dr. Jorge Montes","DrÂª Lucinda da Rocha","DrÂª Priscilla Fontes","Dr. Ronaldo Santana"],

     "Psiquiatria": ["Dr. Rodrigo Pontes","DrÂª Juliana Cunha","DrÂª Eliana Teixeira","Dr. Davi Soares","Dr. Enzo Vieira","DrÂª Valentina Eduarda"]
}


horarios = ['08:00', '08:45', '09:30', '10:15', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00']

#adc regioes e cidades
regioes = {"RegiÃ£o Metropolitana": ["Recife","Paulista","Olinda"],
           "Agreste": ["Garanhuns","Caruaru","VitÃ³ria de Santo AntÃ£o","Bezerros","GravatÃ¡"],
           "SertÃ£o": ["Petrolina","Floresta","Serra Talhada","Arcoverde","Salgueiro"]}


def abrir_calendario():
    janela_cal = tk.Toplevel(app)
    janela_cal.title("Escolha a Data")
    calendario = Calendar(janela_cal, date_pattern="dd/mm/yyyy", locale='pt_BR')
    calendario.pack(pady=10)
    def selecionar_data():
        data_nascimento_var.set(calendario.get_date())
        janela_cal.destroy()
    ctk.CTkButton(janela_cal, text="Selecionar", command=selecionar_data).pack(pady=10)

def cadastrando():
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app, text='Nome Completo:').pack(pady=2)
    nome  = ctk.CTkEntry(app, placeholder_text='Digite seu Nome Completo')
    nome.pack(pady=2)
    ctk.CTkLabel(app, text="CPF:").pack(pady=2)
    cpf = ctk.CTkEntry(app, placeholder_text="Digite seu CPF")
    cpf.pack(pady=2)
    ctk.CTkLabel(app, text="Data de Nascimento:").pack(pady=2)
    data = ctk.CTkEntry(app, textvariable=data_nascimento_var, state="readonly", placeholder_text="Clique para selecionar")
    data.pack(pady=3)
    ctk.CTkButton(app, text="Selecionar Data", command=abrir_calendario).pack(pady=2)
    ctk.CTkLabel(app, text='Email:').pack(pady=1)
    email = ctk.CTkEntry(app, placeholder_text='Digite seu Email')
    email.pack(pady=1)
    ctk.CTkLabel(app, text="Senha:").pack(pady=1)
    senha = ctk.CTkEntry(app, placeholder_text="Digite sua senha:", show='*')
    senha.pack(pady=1)

    def salvar_cadastro():
        global email_cadastrado, senha_cadastrada
        email_cadastrado = email.get()
        senha_cadastrada = senha.get()

        if not nome.get() or not cpf.get() or not data_nascimento_var.get() or not email_cadastrado or not senha_cadastrada:
            ctk.CTkLabel(app, text="âš ï¸ Preencha todos os campos!", text_color="yellow").pack(pady=10)
            return
        sucesso= cadastrar_usuario(nome.get(), cpf.get(), data_nascimento_var.get(), email_cadastrado, senha_cadastrada)
        if sucesso:
            ctk.CTkLabel(app,text="âœ… Cadastro realizado com sucesso!", text_color="green").pack(pady=10)
            app.after(1000, login)
        else:
            ctk.CTkLabel(app, text="âŒ UsuÃ¡rio jÃ¡ cadastrado.", text_color="red").pack(pady=10)
            app.after(1000, login)
        
        login()

    ctk.CTkButton(app, text='Salvar Cadastro', command=salvar_cadastro).pack(pady=10)
    ctk.CTkButton(app, text='Voltar ao Login', command=login).pack(pady=10)
def iniciar_login(login):
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app, text="Sistema de Agendamento de Consultas", font=("Arial", 20)).pack(pady=20)
    ctk.CTkButton(app, text="Iniciar SessÃ£o", command=login).pack(pady=10)

def login():
    for widget in app.winfo_children():
        widget.destroy()
   
    frame_esquerda =ctk.CTkFrame(app,fg_color='#F9F9F9',width=400)
    frame_esquerda.pack(side='left',fill='both')

    imagem = Image.open('images2.jpeg')
    imagem = imagem.resize((330,200))
    img_tk = ImageTk.PhotoImage(imagem)
    ctk.CTkLabel(app, text=" UsuÃ¡rio ğŸ‘¤:").pack(pady=10)
    campo_usuario = ctk.CTkEntry(app, placeholder_text="Digite seu email")
    campo_usuario.pack(pady=10)
    ctk.CTkLabel(app, text=" Senha ğŸ”:").pack(pady=10)
    campo_senha = ctk.CTkEntry (app, placeholder_text="Digite sua senha", show='*')
    campo_senha.pack(pady=10)
    resultado = ctk.CTkLabel(app, text='')
    resultado.pack(pady=10)

    def verificar():
        email=campo_usuario.get()
        senha=campo_senha.get()
        if not campo_usuario.get() or not campo_senha.get():
          resultado.configure(text="âš ï¸ Preencha todos os campos!", text_color="yellow")
          return
        global id_usuario_logado
        id_usuario_logado=verificar_usuario(email, senha) #cria variÃ¡vel global, verifica se ele ta no banco de dados dos usuarios, e pega a id
        if id_usuario_logado:
          resultado.configure(text="âœ… Login bem-sucedido!", text_color="green")
          app.after(1000,lambda: inicio()) #adc tela de inicio
        else:
         resultado.configure(text="âŒ Email ou senha incorretos.", text_color="red")
    ctk.CTkButton(app, text="Efetuar Login", command=verificar).pack(pady=10)

    cads = ctk.CTkLabel(app, text="NÃ£o tem cadastro? Clique aqui ğŸ‘ˆ", text_color="yellow", cursor="hand2")
    cads.pack(pady=10)
    cads.bind("<Button-1>", lambda e: cadastrando())

def inicio():
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app,text="Bem-vindo(a)! O que deseja fazer?").pack(pady=5)
    ctk.CTkButton(app, text="ğŸ‘ï¸ Ver meu histÃ³rico de agendamentos", command=lambda: historico_agendamentos()).pack(pady=10)
    ctk.CTkButton(app,text="ğŸ“… Iniciar sessÃ£o de agendamento de consultas", command=lambda:escolher_regiao()).pack(pady=10)


def escolher_regiao(): #adc def p regiao
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app,text=" Escolha a regiÃ£o desejada ğŸ—ºï¸:").pack(pady=5)
    box_regiao=ctk.CTkOptionMenu(app,values=list(regioes.keys()))
    box_regiao.pack(pady=5)
    ctk.CTkButton(app,text="PrÃ³ximo", command=lambda:escolher_cidade(box_regiao.get())).pack(pady=10)

def escolher_cidade(regiao): #adc def p cidade
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app, text= f"Escolha a cidade em {regiao}:").pack(pady=5)
    cidades=regioes.get(regiao,[])
    box_cidade=ctk.CTkOptionMenu(app,values=cidades)
    box_cidade.pack(pady=5)
    ctk.CTkButton(app,text="PrÃ³ximo", command=lambda: escolher_especialidade(regiao,box_cidade.get())).pack(pady=10)


def escolher_especialidade(regiao,cidade):
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app, text="ğŸ©º Escolha a especialidade:").pack(pady=5)
    box_esp = ctk.CTkOptionMenu(app, values=list(profissionais.keys()))
    box_esp.pack(pady=5)
    ctk.CTkButton(app, text="PrÃ³ximo", command=lambda: escolher_profissional(regiao,cidade,box_esp.get())).pack(pady=10)
def escolher_profissional(regiao,cidade,especialidade):
    for widget in app.winfo_children():
        widget.destroy()

    data_var = tk.StringVar()

    ctk.CTkLabel(app, text=f"ğŸ‘¨â€âš•ï¸ Profissionais disponÃ­veis ({especialidade}):").pack(pady=5)

    nomes = profissionais.get(especialidade, [])
    box_prof = ctk.CTkOptionMenu(app, values=nomes)
    box_prof.pack(pady=5)

    ctk.CTkLabel(app, text='ğŸ“… Data da consulta:').pack(pady=5)
    entrada_data = ctk.CTkEntry(app, textvariable=data_var, state="readonly", placeholder_text="Clique no botÃ£o para escolher a data")
    entrada_data.pack(pady=5)

    def abrir_calendario():
        janela = tk.Toplevel(app)
        janela.title("Selecionar Data")
        data_inicio=date.today()
        data_final=data_inicio+timedelta(days=30) #adiciona 30 dias Ã  data de inÃ­cio,ent essa Ã© a data limite p selecionar
        calendario = Calendar(janela, date_pattern="dd/mm/yyyy", locale='pt_BR',mindate=data_inicio,maxdate=data_final)
        calendario.pack(pady=10)

        aviso_dias = ctk.CTkLabel(janela, text="", text_color="red")
        aviso_dias.pack(pady=10)

        def escolher():
            data_escolhida=calendario.get_date()
            data_str=datetime.strptime(data_escolhida,"%d/%m/%Y")
            if data_str.weekday()>=5:
                aviso_dias.configure(text="âŒ Os atendimentos sÃ³ sÃ£o realizados em dias Ãºteis. Escolha outra data") #msg caso nao escolha dia de semana
            else:
                data_var.set(calendario.get_date())
                janela.destroy()

        ctk.CTkButton(janela, text="Confirmar Data", command=escolher).pack(pady=10)

    ctk.CTkButton(app, text="Selecionar Data", command=abrir_calendario).pack(pady=5)    

    ctk.CTkLabel(app, text="ğŸ•’ HorÃ¡rio disponÃ­vel:").pack(pady=5)
    box_horario = ctk.CTkOptionMenu(app, values=horarios)
    box_horario.pack(pady=5)

    

    resultado_label = ctk.CTkLabel(app, text="")
    resultado_label.pack(pady=5)

    def confirmar():
        prof = box_prof.get()
        horario = box_horario.get()
        data = data_var.get()

        if not prof or not horario or not data:
            resultado_label.configure(text="âš ï¸ Preencha todos os campos!", text_color="orange")
        else:
            resultado_label.configure(
                text=f"âœ… Consulta marcada com {prof} ({especialidade})\nğŸ—“ï¸ {data} Ã s {horario}",
                text_color="green"
            )
            app.after(1000, lambda:confirmar_agendamento(regiao,cidade,especialidade,prof,horario,data))

    ctk.CTkButton(app, text="Confirmar Agendamento", command=lambda: confirmar()).pack(pady=10)

    ctk.CTkButton(app, text="Voltar", command=lambda: escolher_especialidade(regiao,cidade)).pack(pady=5)


    resultado_label = ctk.CTkLabel(app, text="")
    resultado_label.pack(pady=5)

#adc regiao e cidade aqui
def confirmar_agendamento(regiao,cidade,especialidade, profissional, horario, data):
    for widget in app.winfo_children():
        widget.destroy()
    cursor2.execute("insert into agendamentos (especialidade, profissional,horario,data, usuario_id) values (?,?,?,?,?) ",(especialidade,profissional,horario,data,id_usuario_logado)) #guarda em agendamentos
    conector2.commit()
    ctk.CTkLabel(app, text=f"Consulta marcada em {regiao}, na cidade de {cidade}, com {profissional}\nEspecialidade: {especialidade}\nData: {data}\nHorÃ¡rio: {horario}", text_color="green").pack(pady=10)
    ctk.CTkButton(app, text="Sair", command=app.quit).pack(pady=10)
    ctk.CTkButton(app, text="Ver meu histÃ³rico de agendamentos", command=lambda: historico_agendamentos()).pack(pady=10)

def historico_agendamentos():
    for widget in app.winfo_children():
        widget.destroy()
    ctk.CTkLabel(app, text="ğŸ“œ HistÃ³rico de Agendamentos").pack(pady=10)

    cursor2.execute('SELECT * FROM agendamentos WHERE usuario_id=?', [id_usuario_logado])
    agendamentos = cursor2.fetchall()
    
    if not agendamentos:
        ctk.CTkLabel(app, text="Nenhum agendamento encontrado.").pack(pady=10)
    else:
        for agendamento in agendamentos:
            ctk.CTkLabel(app, text=f"ID: {agendamento[0]}, Especialidade: {agendamento[1]}, Profissional: {agendamento[2]}, HorÃ¡rio: {agendamento[3]}, Data: {agendamento[4]}").pack(pady=5)

    ctk.CTkButton(app, text="Voltar", command=login).pack(pady=10)

login()
app.mainloop()

#O QUE FALTA: 1- ORGANIZAR MÃ‰DICOS POR CIDADES/ 2- BUG DO HISTORICO??/ 3- PARTE VISUAL/ 4- CONDICIONAIS DO E-MAIL E CPF ...